<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link href="https://fonts.googleapis.com/css?family=Lato:100italic,100,300italic,300,400italic,400,700italic,700,900italic,900" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="assets/bootstrap/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="assets/css/styles.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />
    <title>SpeziSpezl</title>
    <script type="text/javascript" src="assets/jquery.min.js"></script>
    <script type="text/javascript" src="assets/moment.min.js"></script>
    

  </head>
  <body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
  <div id="container">
    <div id="body">

    <div id="howto" style="display: none;">
      <section class="container">
          <div class="howto">
            <h2>Noch kein SpeziSpezl?</h2>
            <ol class="circle"> 
              <li><p class="paragraph">Halte deine StudentCard oder PersonalCard an den Kartenleser am Automaten und scanne den angezeigt Registrierungs QR-Code.<br>Alternativ kannst du deine Karte auch mit deinem NFC-fähigen Android Smartphone mit dem Chrome Browser auslesen (Wird unterstützt, wenn der Link "Einfach StudentCard mit dem Smartphone scannen" auf der <a href="https://www.spezispezl.de">Startseite</a> angezeigt wird)</p></li> 
              <li><p class="paragraph">Lege einen Account an. Verwende am besten die selbe E-mail Adresse und Namen, wie duch auch für deinen Paypal Account verwendest. Dadurch können die Einzahlungen automatisch zugeordnet werden.</p></li> 
              <li><p class="paragraph">Bestätige deine E-mail Adresse über den Link in der E-mail.</p></li> 
              <li><p class="paragraph">Lade dein Guthaben auf. Sende hierzu den gewünschten Betrag über Paypal Familie&Freunde an <a href="https://www.paypal.com/paypalme/spezispezl">SpeziSpezl</a>
                (<a href="mailto:spezispezl@mail.de">spezispezl@mail.de</a>).
                          Verwende als Mitteilung am besten deine E-mail Adresse, um die Zahlung besser zuordnen zu können. Deine Aufladung wird innerhalb weniger Minuten automatisch verarbeitet und du erhälst eine Bestätigungsmail.</p> </li> 
              <li><p class="paragraph">Nun kannst du den Getränkeservice von SpeziSpezl verwenden.</p></li> 
            </ol>
          </div>
        <div class="faq">
          <h2>FAQ</h2>
          <p class="question">Was kosten die Getränke bei SpeziSpezl?</p>
          <p class="answer">Du kannst die gesamte <a href="https://spezispezl.de/stock/">Preisliste auch online</a> einsehen. Am Getränkeautomaten werden die Preise auch bei der Fachauswahl angezeigt. </p>
          <p class="question">Mein Guthaben ist weniger gutgeschrieben worden als ich gesendet habe. Was ist da los?</p>
          <p class="answer">Du hast bei der Zahlung "Waren und Dienstleistungen" gewählt. Dafür fallen bei PayPal Gebühren an, die der Zahlungempfänger trägt. Diese Gebühren von uns weitergegeben und von deinem Guthaben abgezogen.</p>
          <p class="question">Wie werden die Preise gewählt?</p>
          <p class="answer">Der Getränkeservice verfolgt keine Gewinnabsicht, daher orientieren sich die Verkaufspreise sehr nah an den Einkaufspreisen</p>
          <p class="question">Wozu brauche ich meine Student- bzw. PersonalCard?</p>
          <p class="answer">Damit Identifizierst du dich an den Automaten. Es wird nur die Karten-ID verwendet, dein Mensa Guthaben kann nicht verwendet werden.</p>
          <p class="question">Meine Karte wird nicht erkannt. Was kann ich tun?</p>
          <p class="answer">Es werden alle Karten unterstützt, die der ISO-15693 entsprechen. Ältere Mitarbeiter und Mensa-Karten unterstützen dies noch nicht. Du kannst auch andere Karten zur Identifizierung verwenden, probiere es einfach aus. (Skipässe, ...) </p>
          <p class="question">Kann ich bei Paypal auch Waren & Dienstleistungen wählen?</p>
          <p class="answer">Ja, jedoch werden die Paypal Gebühren von deinem Guthaben abgezogen.</p>
          <p class="question">Muss ich mein Guthaben zuerst aufladen?</p> 
          <p class="answer">Ja. Mitarbeiter die Möglichkeit ihren Account zu überziehen. Zur Freischaltung bitte einen Supportanfrage stellen.</p>
          <p class="question">Kann ich mehrere Karten auf einen Paypal-Account anmelden </p>
          <p class="answer">Ja, dazu einfach die zusätzliche Karte einlesen und statt der Registrierung auf "Einloggen" klicken.</p>
          <p class="question">Ich will mein Guthaben zurückgebucht bekommen</p>
          <p class="answer">Schreibe einfach eine Supportanfrage, wir werden uns schnellstmöglich darum kümmern.</p>
        </div> 
        <div class="faq">
              Alles klar? <a href="https://spezispezl.de/" onclick="window.location.href = 'https://spezispezl.de/'; window.location.reload();">Hier geht's zum Login</a>
            </div>
      </section>
    </div>

    
    <div id="login" style="display: none;">
      <section class="container">
        <section class="login-form">
          <form name="login" role="login">
            <section class="form-outer">
              <h2>SpeziSpezl Login</h2>
              <input type="text" autocomplete="username" name="mail" placeholder="e-mail" required class="form-control input-lg">
              <input type="password" autocomplete="current-password" name="passwd" placeholder="Password" required class="form-control input-lg">
              <button type="submit" value="Login" name="go" class="btn btn-lg btn-block">Login</button>
              <p id="wrong_pw" class="wrong_pw" style="display: none;"></p>
            </section>
            <div id="register_desktop" class="form-outer">
              Noch kein Account? <a href="#howto" onclick="window.location.href ='https://spezispezl.de/#howto'; window.location.reload();">Hier geht's zur Anleitung</a>
            </div>
            <div id="register_mobile" class="form-outer" role="login">
              Noch kein Account? <button type="button" id="scan" onclick="read_card()">Einfach StudentCard mit dem Smartphone scannen</button>
              <p id="scan_info" class="wrong_pw" style="display: none;"></p>
              <img src="/assets/images/scan.png" id="scan_img" class="scan_img" style="display: none;"></p>
               
                Verwirrt? <a href="#howto" onclick="window.location.href ='https://spezispezl.de/#howto'; window.location.reload();">Hier geht's zu den FAQs</a>
            </div>
          </form>
        </section>
      </section>
    </div>


    <div id="register" style="display: none;">
      <section class="container">
        <section class="login-form">
      <form name="form_register" role="login" class="register_form">
        <section class="form-outer">
          <h2>SpeziSpezl Registrierung</h2>
          <section id="card_id" class="card_id"> </section>
          <div id="reg_form">
        <input type="text" autocomplete="family-name" name="mname" required class="form-control input-lg" placeholder="Nachname (wie bei PayPal)">
        <input type="text" autocomplete="given-name" name="sname" required class="form-control input-lg" placeholder="Vorname (wie bei PayPal)">
        <input type="text" autocomplete="email" name="mail" required class="form-control input-lg" placeholder="e-Mail">
        <input type="password" autocomplete="new-password" name="passwd" required class="form-control input-lg" placeholder="Passwort">
        <INPUT TYPE="hidden" NAME="card_id" VALUE="">
        <button type="submit" value="Login" name="go" class="btn btn-lg btn-block">Anmelden</button>
        <p id="register_warn" class="wrong_pw" style="display: none;">Dein Name enthält ein Leerzeichen.<br>Bitte ggf. korrigieren oder bestätigen</p>
        Bereits einen Account? <br><a href="#add_card" onclick="window.location.href = window.location.search +'#add_card'; window.location.reload();">Hier anmelden und Karte hinzufügen</a>
        </div>
        </section>
        <div id="register_cont" class="form-outer">
              Fragen? <a href="https://spezispezl.de/#howto" onclick="window.location.href = 'https://spezispezl.de/#howto'; window.location.reload();">Hier geht's zur Anleitung</a>
            </div>
      </form>
     </section>
      </section>
    </div>

    <div id="validate_mail" style="display: none;">
      <section class="container">
        <section class="login-form">
          <form name="val_email" role="login">
            <section class="form-outer">
              <h2>E-mail Adresse bestätigen</h2>
              <INPUT TYPE="hidden" NAME="token" VALUE="">
              <button id="verify_btn" type="submit" value="Bestätigen" name="go" class="btn btn-lg btn-block">Bestätigen</button>
            </section>
            <div id="verify_cont" class="form-outer" style="display: none;">
              E-mail Adresse erfolgreich bestätigt.<br><br>
              Lade als nächstes dein Guthaben auf:<br>Sende dazu den gewünschten Betrag über PayPal an <a href="mailto:spezispezl@mail.de">spezispezl@mail.de</a> bzw. <a href="https://www.paypal.com/paypalme/spezispezl">SpeziSpezls Paypal.me</a><br><br><b>Achtung:</b><br> Achte drauf <b>Familie und Freunde</b> auszuwählen, da die Gebühren ansonsten von deinem Guthaben abgezogen werden.<br><br><img src="/assets/images/pp.png" id="pp_img" class="scan_img"><br><br>Die Aufladung wird automatisch verarbeitet und normalerweise innerhalb einer Minute deinem Account gutgeschrieben.<br>
              <a href="https://spezispezl.de/">Hier geht es zum Login</a><br>Noch Fragen? <a href="https://spezispezl.de/#howto" onclick="window.location.href = 'https://spezispezl.de/#howto'; window.location.reload();">Hier geht's zu den FAQs</a>
            </div>
          </form>
        </section>
      </section>
    </div>

    

    <div id="resetpassword" style="display: none;">
      <section class="container">
        <section class="login-form">
          <form name="reset_password" role="login">
            <section class="form-outer">
              <h2>Passwort vergessen</h2>
                    <input type="text" autocomplete="email" name="mail" required class="form-control input-lg" placeholder="e-Mail">
                    <button name="go" type="submit" class="btn btn-lg btn-block">Passwort zurücksetzen</button>
            </section>
            <div class="form-outer">
              <a href="https://spezispezl.de" onclick="window.location.href = 'https://spezispezl.de'; window.location.reload();">Zurück zur Übersicht</a>
            </div>
          </form>
        </section>
      </section>
    </div>

    <div id="set_passwd" style="display: none;">
      <section class="container">
        <section class="login-form">
          <form name="set_passwd" role="login">
            <section class="form-outer">
              <h2>neues Passwort setzen</h2>
                <INPUT TYPE="hidden" NAME="token" VALUE="">
                <INPUT TYPE="hidden" NAME="username" VALUE="">
                <input id="snpw" name="pw_new" type="password" autocomplete="new-password" required class="form-control input-lg" placeholder="neues Passswort"></input>
                <input id="snpwr" name="pw_new_rep" type="password" autocomplete="new-password" required class="form-control input-lg" placeholder="neues Passswort wiederholen" onkeyup="check_pw('snpw', 'snpwr', 'spw_msg');"></input>
                <p id="spw_msg" style="display: none;"></p>
                <button name="go" type="submit" class="btn btn-lg btn-block">Passwort ändern</button>
            </section>
            <div class="form-outer">
              <a href="https://spezispezl.de" onclick="window.location.href = 'https://spezispezl.de'; window.location.reload();">Zurück zur Übersicht</a>
            </div>
          </form>
        </section>
      </section>
    </div>


    <div id="add_card" style="display: none;">
      <section class="container">
        <section class="login-form">
          <form name="login" role="login">
            <section class="form-outer">
              <h2>Karte hinzufügen</h2>
                    <section id="card_id2" class="card_id"> </section>
                    <button name="go" class="btn btn-lg btn-block" onclick="add_card();">Karte hinzufügen</button>
            </section>
            <div class="form-outer">
              <a href="https://spezispezl.de" onclick="window.location.href = 'https://spezispezl.de'; window.location.reload();">Zurück zur Übersicht</a>
            </div>
          </form>
        </section>
      </section>
    </div>

    <div id="transactions" style="display: none;">
      <section class="table-background">
        <span id="paypalmail" class="paypalmail">Guthaben aufladen: <a href="mailto:spezispezl@mail.de">spezispezl@mail.de</a></span>
        <h2>Transaktionen</h2>
        <div id="balance"></div><div id="stock" class="stock"><a href="https://spezispezl.de/stock/">Preisliste</a></div>

        <br>
        <div id="transaction-table">
        </div>
        <div id=load_more_transactions style="display: none;">
          <button class="astext" onclick="load_more_transactions()">mehr...</button>
        </div>
      </section>
      <section class="table-background">
        <h2>Aktionen</h2>
        <div id="actions" class="btn_action">
          <button onclick="window.open('https://paypal.me/spezispezl');" type="button" value="Guthaben aufladen" name="go" onclick="" class="btn btn-lg btn-block">Guthaben aufladen</button>
          
        <div id="supply_block" style="display: none;">
            <br>
            <button value="Einkauf eintragen" name="go" onclick="get_products(); get_devices(); toggle_div('supply');" class="btn btn-lg btn-block">Einkauf eintragen</button>
            <div id="supply" style="display: none;">
              <form name="supply" role="supply">
                <label for="supply_device" class="fill_text">Automat:</label>
                <select id="supply_device" onchange="get_device_config(document.getElementById('supply_device').value);"></select><br><br>
                <input id="supply_price" name="supply_price" required class="form-control input-lg" placeholder="Betrag"></input><br>
                <input id="supply_comment" name="supply_comment" required class="form-control input-lg" placeholder="Kommentar"></input><br>
                <button id="fillup_btn" type="submit">Eintragen</button>
              </form>
            </div>
          </div>

          <div id="fillup" style="display: none;">
            <br>
            <button value="Auffüllen" name="go" onclick="get_products(); get_devices(); toggle_div('fill');" class="btn btn-lg btn-block">Auffüllen</button>
            <div id="fill" style="display: none;">
              <form name="fillup" role="fillup">
                <label for="fillup_device" class="fill_text">Automat:</label>
                <select id="fillup_device" onchange="get_device_config(document.getElementById('fillup_device').value);"></select><br><br>
                <div id="fill_table" style="display: none;"></div>
                <button id="fillup_btn" type="submit">Aufgefüllt</button>
              </form>
            </div>
          </div>
          <br>
          <button value="Karten verwalten" name="go" onclick="show_cards(); toggle_div('card_list');" class="btn btn-lg btn-block">Karten verwalten</button>
          <div id="card_list" class="fill_text" style="display: none;"> </div>
          <br>
          
          <button id="bal_alert_btn" type="button" class="btn btn-lg btn-block" onclick="toggle_div('balance_alert');">Balance Alert</button>
          <div id="balance_alert" style="display: none;">
            <p class="question">Erhalt eine Benachrichtigung, wenn dein Guthaben unter diesen Betrag fällt. Benutze -1 zum deaktivieren.</p>
            <form name="form_balance_alert">
              <input id="alert_amount" name="alert_amount" required class="form-control input-lg" placeholder="Betrag"></input>
              <button id="balance_alert_btn" type="submit">Aktualisieren</button>
            </form>
          </div>
          <br>
          <button value="Support" name="go" onclick="toggle_div('support');" class="btn btn-lg btn-block">Support</button>
          <div id="support" style="display: none;">
            <form name="form_support">
              <textarea name="message" rows="5" required class="form-control input-lg" placeholder="Deine Nachricht..."></textarea>
              <button id="support_btn" type="submit">Absenden</button>
            </form>
          </div>
          <br>
          <button value="Passwort ändern" name="go" onclick="toggle_div('change_passwd');" class="btn btn-lg btn-block">Passwort ändern</button>
          <div id="change_passwd" style="display: none;">
            <form name="form_change_passwd">
              <INPUT TYPE="hidden" NAME="mail" autocomplete="username" VALUE="">
              <input name="pw_current" type="password" autocomplete="current-password" required class="form-control input-lg" placeholder="aktuelles Passswort"></input>
              <input id="npw" name="pw_new" type="password" autocomplete="new-password" required class="form-control input-lg" placeholder="neues Passswort"></input>
              <input id="npwr" name="pw_new_rep" type="password" autocomplete="new-password" required class="form-control input-lg" placeholder="neues Passswort wiederholen" onkeyup="check_pw('npw', 'npwr', 'pw_msg');"></input>
              <p id="pw_msg" style="display: none;"></p>
              <button id="change_pw_btn" type="submit">Passwort ändern</button>
            </form>
          </div>
          <br>
          <button id="logout" type="button" class="btn btn-lg btn-block" onclick="logout();">Logout</button>
      </div>

      </section>
    </div>
    </div>
  <div class="footer"><span class="impr" data-text="Lieber Sebastian, diese Seite ist ausschließlich für den internen Gebrauch bestimmt und verfolgt keinerlei öffentlichkeitswirksame Absicht.">Impressum & Datenschutz</span><span class="pricelink"><a href="https://spezispezl.de/stock/">Preisliste</a></span></div>
</div>

<script>
const api = "https://spezispezl.de/api2"
let token;
let params;
let mail;
let balance_alert;
let user_level;
var devices;
var products;

var transaction_data;
const transaction_block = 15;
var num_transactions = 0;
var num_transactions_shown = 0
var last_name_checked = false;

$("form").on('submit', function (e) {
  e.preventDefault();
  submitForm(e);
});

function check_pw(ida, idb, div){
  if (document.getElementById(ida).value ==
    document.getElementById(idb).value) {
    hide_div(div);
  } else {
    document.getElementById(div).style.color = 'red';
    document.getElementById(div).innerHTML = 'Die Passwörter stimmen nicht überein';
    show_div(div);
  }
}

function validateEmail(email) 
    {
        var re = /\S+@\S+\.\S+/;
        return re.test(email);
    }

function scan_error(text, color) {
  let div = document.getElementById ('scan_info');
  div.innerHTML=text;
  div.style.color=color;
  show_div('scan_info');
  show_div('scan_img');
}

async function read_card(){
   scan_error("Karte ans Smartphone halten!", "white");
   let suc = false;
   let scanning = false;
    const ndef = new NDEFReader();

    ndef.addEventListener("readingerror", () => {
      scanning = false;
      scan_error("Fehler beim Lesen, bitte erneut versuchen", "red");
   });

   ndef.addEventListener("reading", ({ message, serialNumber }) => {
    let id = serialNumber.replaceAll(':','').toUpperCase();
    if(id.length < 16){
      id = id.match(/[a-fA-F0-9]{2}/g).reverse().join(''); // reverse order

      if(id.length == 8){
        id = `000000${id}E0`;
      }
      if(id.length == 14){
        id = `${id}E0`;
      }
    }
    //000000F77D93A6E0
    //3D356F3D043816E0
    //00000000000000E0

    console.log(`CardId: ${id}`);
    //if(id.endsWith("E0")){
      suc = true;
      location.replace(`https://spezispezl.de/?card_id=${id}`);
    //} else {
    //  scan_error("Dieser Kartentyp wird nicht unterstützt", "red");
    //}
   });
   //timeout = setTimeout(function(){suc=true; scan_error("Timeout, bitte ", "red");}, 10000);
    if(!suc){
      if(!scanning){
        scanning = true;
        ndef.scan();
      }
   


 }
}

function show_login(){
    show_div('login');
   if("NDEFReader" in window){
      show_div('register_mobile');
    } else {
      show_div('register_desktop');
    }
}

function init(){

  hide_div('paypalmail')
  hide_div('login');
  hide_div('wrong_pw');
  hide_div('transactions');
  hide_div('register');
  hide_div('logout');
  hide_div('validate_mail');
  hide_div('support');
  hide_div('fillup');
  hide_div('supply_block');
  hide_div('register_mobile');
  hide_div('register_desktop');
  hide_div('resetpassword');
  hide_div('scan_info');
  hide_div('scan_img');
  

  params = new URLSearchParams(window.location.search);
  let ctoken = (document.cookie.match(/^(?:.*;)?\s*spezl_login\s*=\s*([^;]+)(?:.*)?$/)||[,null])[1];
  if(ctoken && !token){
    token = ctoken;
  }
  //console.log(token);
  if(params.get('card_id') || window.location.hash == '#register') {
    if(window.location.hash == '#add_card'){
      if(token == "" || token == null){
        show_login();
      } else {
        let div = document.getElementById ('card_id2');
        div.innerHTML=`CardID: ${params.get('card_id')}`;
        show_div('add_card');
      }
    } else {
      display_register(params.get('card_id'));
    }
  }
  else if(params.get('reset_passwd_token')){display_reset_passwd();}
  else if(params.get('token')) { display_validate_mail();}
  else if(window.location.hash == '#howto') { show_div('howto');}
  else if(window.location.hash == '#resetpassword'){show_div('resetpassword');}
  else if(token == null || token ==""){
    show_login();
  } else {
    show_div('logout');
    //console.log(token);
    if(window.location.hash == '#add_card'){
      show_div('add_card');
    } else {
      if(check_mobile()){
        show_div('paypalmail');
      }
      get_transactions();
      get_balance();
    }
  }    
}

function submitForm(e) {
  //console.log(e.target.name)
  if(e.target.name == 'login'){
    var url = `${api}/login`;
    var m = document.forms["login"]["mail"].value
    var p = document.forms["login"]["passwd"].value
    var data = `mail=${m}&passwd=${p}`
    httpGetAsync(url,do_login, data);
  }
  else if(e.target.name == 'form_register'){
    var has_no_space = true;

    if(document.forms["form_register"]["mname"].value.trim().indexOf(' ') >= 0){
      has_no_space = false;
    }

    var url = `${api}/register_user`;
    var m = document.forms["form_register"]["mail"].value.trim()
    var p = document.forms["form_register"]["passwd"].value
    var s = document.forms["form_register"]["sname"].value.trim()
    var n = document.forms["form_register"]["mname"].value.trim()
    var c = document.forms["form_register"]["card_id"].value
    if( m!= "" && p!= "" & s!= "" && n!= "" && c!= "" && validateEmail(m) && (has_no_space || (!has_no_space && last_name_checked) )){
      var data = `mail=${m}&passwd=${p}&surname=${s}&name=${n}&card_id=${c}`
      httpGetAsync(url,do_register, data);
    } 
    else if(!has_no_space){
      last_name_checked = true;
      show_div('register_warn');
    }
    else {
      alert("Daten unvollständig");
    }
  }
  else if(e.target.name == 'val_email'){
    var url = `${api}/verify`;
    httpGetAsync(url,do_validate_mail,`token=${params.get('token')}`);
  }
  else if(e.target.name == 'form_support'){
    if(token != null){
      send_support(document.forms["form_support"]["message"].value);
    } else {
      alert("not logged in");
    }
  }
  else if(e.target.name == 'form_balance_alert'){
    set_balance_alert(document.forms["form_balance_alert"]["alert_amount"].value)
  }
  else if(e.target.name == 'supply'){
    send_supply(devices[document.forms["supply"]["supply_device"].value].device, document.forms["supply"]["supply_price"].value, document.forms["supply"]["supply_comment"].value);
  }
  else if(e.target.name == 'fillup'){
    var slots = parseInt(devices[document.getElementById('fillup_device').value].slots)
    var data = [{}];
    for(var i=0; i< slots; i++){
      data[i] = {};
      data[i]['slot']= i+1;
      data[i]['product'] = document.getElementById(`product_${i}`).value;
      data[i]['items']= document.getElementById(`items_${i}`).value;
    }
    send_fillup(JSON.stringify(data), devices[document.getElementById('fillup_device').value].device);
  }
  else if(e.target.name == 'form_change_passwd'){
    if(token != null){
      set_password(token, document.forms["form_change_passwd"]["pw_new"].value, document.forms["form_change_passwd"]["pw_current"].value);
    } else {
      alert("not logged in");
    }
  }
  else if(e.target.name == 'reset_password'){
      reset_password(document.forms["reset_password"]["mail"].value);
  }
  else if(e.target.name == 'set_passwd'){
    var t = document.forms["set_passwd"]["token"].value;
    if(t != null){
      set_password(t, document.forms["set_passwd"]["snpw"].value);
    } else {
      alert("not allowed");
    }
  }
  
  return false;
}

function do_register(resp) {
  var obj = JSON.parse(resp);
  if('state' in obj){
    if(obj.state == 'success'){
      let reg_form = document.getElementById("reg_form");
      reg_form.style.display = 'none';
      let div = document.getElementById("register_cont");
      div.innerHTML = `Registrierung erfolgreich.<br>Bitte bestätige deine E-mail Adresse`;
    } else {
      //console.log(obj);
      alert(obj.state);
    }
  }
}

function do_validate_mail(resp) {
  var obj = JSON.parse(resp);
  if('state' in obj){
    if(obj.state == 'success'){
      hide_div('verify_btn');
      show_div('verify_cont');
    } else {
      alert(obj.state);
      //console.log(obj);
    }
  }
}

function do_login(resp){
  var obj = JSON.parse(resp);
   let div = document.getElementById ('wrong_pw');
  if (!navigator.cookieEnabled){
      div.innerHTML=`Bitte aktiviere Cookies in deinem Browser um eingeloggt zu bleiben`;
      show_div('wrong_pw');
  }
  if('token' in obj){
      document.cookie = `spezl_login=${obj.token}`;
      token = obj.token;
      init();

    } else if('state' in obj && obj.state == 'wrong password'){
      
      div.innerHTML=`Passwort falsch <br> <a href="https://spezispezl.de/#resetpassword" onclick="window.location.href += '#resetpassword'; window.location.reload();">Passwort vergessen?</a>`;
      show_div('wrong_pw');
    }
    else if('state' in obj && obj.state == 'user not found'){
      div.innerHTML=`unbekannter Benutzer`;
      show_div('wrong_pw');
    }
    else {
      div.innerHTML=`Fehler: ${obj}`;
      show_div('wrong_pw');
    }
}

function logout(){
  url = `${api}/logout`;
  httpGetAsync(url,do_logout,`token=${token}`);
}

function del_token() {
  document.cookie = 'spezl_login=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
  token = null;
  mail="";
  balance_alert=-1;
  user_level ="";
  init();
}

function do_logout(resp){
  var obj = JSON.parse(resp);
  if('state' in obj){
    if(obj.state == 'success'){
      del_token();
    }
  }
}

function show_div(name){
  let div = document.getElementById (name);
  div.style.display = 'block';
}

function hide_div(name){
  let div = document.getElementById (name);
  div.style.display = 'none';
}

function toggle_div(name){
  let div = document.getElementById (name);
  if( div.style.display == 'none'){
    div.style.display = 'block';
  } else {div.style.display = 'none';}
}

function display_register(cid){
  document.forms["form_register"]["card_id"].value = cid;
  show_div('register');
  let div = document.getElementById ('card_id');
  div.innerHTML=`CardID: ${cid}`;
}

function display_validate_mail(){
  document.forms["val_email"]["token"].value = params.get('token');
  show_div('validate_mail');
}

function display_reset_passwd(){
  document.forms["set_passwd"]["token"].value = params.get('reset_passwd_token');
  show_div('set_passwd');
}

function get_balance(){
  url = `${api}/get_balance`;
  httpGetAsync(url,display_balance,`token=${token}`);
}
function display_balance(resp){
  var obj = JSON.parse(resp);
  //console.log(obj);
  if('state' in obj){
    console.log(obj);
  } else {

      let div = document.getElementById ('balance');
      div.innerHTML = `Aktuelles Guthaben: ${obj.balance} €`; // <a href="https://www.paypal.com/paypalme/spezispezl">Hier aufladen</a>
      mail = obj.mail;
      user_level = obj.user_level;
      balance_alert = obj.balance_alert;
      div=document.getElementById ('alert_amount');
      div.value=balance_alert;
      if(obj.is_filler){
        show_div('fillup');
        show_div('supply_block');
      }


  }
}

function add_card(){
  url = `${api}/add_card`;
  httpGetAsync(url,handle_add_card,`token=${token}&card_id=${params.get('card_id')}`);
}
function handle_add_card(resp){
  var obj = JSON.parse(resp);
  if(obj.state == 'success'){
    alert(`Die Karte ${params.get('card_id')} wurde zu deinem Account hinzugefügt.`);
    window.location.href = 'https://spezispezl.de/'; 
    window.location.reload();
  } else {
    console.log(obj);
    alert(`Fehler: ${obj.state}`);
  }
}

function show_cards(){
  url = `${api}/list_cards`;
  httpGetAsync(url,handle_show_cards,`token=${token}`);
}

function handle_show_cards(resp){
  var obj = JSON.parse(resp);
  if(obj.state){
    console.log(obj);
  }
    else {
      let div = document.getElementById ('card_list');
      div.innerHTML = "";
      for(s of obj){
        div.innerHTML += `${s.card_id} Hinzugefügt am: ${moment(new Date(Date.parse(s.added))).format('DD.MM.YY HH:mm')}<br>`
      }
    }
}

function set_balance_alert(amount){
  url = `${api}/set_balance_alert`;
  httpGetAsync(url,handle_balance_alert,`token=${token}&alert=${amount}`);
}
function handle_balance_alert(resp){
  var obj = JSON.parse(resp);
  if(obj.state == 'success'){
    alert("Guthabensbenachrichtigung aktiviert");
  } else {
    console.log(obj);
  }
}

function get_transactions(){
  url = `${api}/list_transactions`;
  httpGetAsync(url,display_transaction,`token=${token}`);
}

function display_transaction(resp){
  var obj = JSON.parse(resp);
  if('state' in obj){
    //console.log(obj);
    //del_token(); // error, logout
    transaction_data = [{'Transaktionen':'Keine Einträge vorhanden'}];
  } else {
    //console.log(obj);
    transaction_data = [{}];
    var line = 0;
    for (var d of obj) {
      //console.log(d);
      transaction_data[line] = {};
      transaction_data[line]['Datum']= moment(new Date(Date.parse(d.time))).format('DD.MM.YY HH:mm');
      // if(d.source =='sielaff') {transaction_data[line].Art = 'Getränkeautomat'; }
      // if(d.source =='paypal') {transaction_data[line].Art = 'PayPal'; }
      // transaction_data[line].Slot=d.slot;
      //transaction_data[line]['Paypal Gebühr'] = d.fee + ' €';
      if(d.fee>0){
        transaction_data[line]['Betrag'] = `<span class="toolt" data-text="${(parseFloat(d.price) + parseFloat(d.fee)).toFixed(2)} € - ${d.fee} € Paypal Gebühr\nVerwende Paypal Freunde&Familie um das zu vermeiden.">${d.price} €</span>`;
      } else {
        transaction_data[line]['Betrag'] = `${d.price} €`;
      }
      if(d.transaction_id == null){
        transaction_data[line]['Produkt']=`${d.display_name}`;
      } else {
        //d.transaction_id = "";
        transaction_data[line]['Produkt']=`<span class="toolt" data-text="Transaktions ID: ${d.transaction_id}">${d.display_name}</span>`;
      }
      transaction_data[line]['Guthaben']=d.balance_new +' €' ;
      
      //transaction_data[line]['Transaktions ID']=`<p class="transaction_id">${d.transaction_id}</p>`  ;
      line = line +1;
      //transaction_data.sender = obj.sender;
    }
  }

    num_transactions = transaction_data.length;
    //console.log(transaction_data);
    load_more_transactions();
}

function load_more_transactions(){
   if(num_transactions > num_transactions_shown + transaction_block){
    num_transactions_shown += transaction_block;
   } else {
    num_transactions_shown = num_transactions;
   }

  if(num_transactions_shown != num_transactions){
    show_div('load_more_transactions');
  } else {
    hide_div('load_more_transactions');
  }

  CreateTableFromJSON('transaction-table', transaction_data, num_transactions_shown);
  let div = document.getElementById ('transactions');
  div.style.display = 'block';
}

function send_support(msg){
  url = `${api}/contact`;
  httpGetAsync(url,handle_support, `token=${token}&msg=${msg}`);
}

function handle_support(resp){
  var obj = JSON.parse(resp);
  if(obj.state == 'success'){
    alert("Nachricht gesendet");
  } else {
    console.log(obj);
  }
}

function send_fillup(data, device){
  url = `${api}/fillup`;
  httpGetAsync(url,handle_fillup, `token=${token}&device=${device}&data=${data}`);
}

function handle_fillup(resp){
  var obj = JSON.parse(resp);
  if(obj.state == 'success'){
    hide_div('fill');
    alert("Daten erfolgreich übermittelt");
  } else {
    console.log(obj);
    alert("Fehler");
  }
}

function send_supply(device, price, comment){
  url = `${api}/supply`;
  httpGetAsync(url,handle_supply, `token=${token}&device=${device}&price=${price}&comment=${comment}`);
}

function handle_supply(resp){
  var obj = JSON.parse(resp);
  if(obj.state == 'success'){
    hide_div('supply');
    alert("Daten erfolgreich übermittelt");
  } else {
    console.log(obj);
    alert("Fehler");
  }
}

function get_devices(){
  url = `${api}/get_devices`;
  httpGetAsync(url,handle_get_devices);
}

function handle_get_devices(resp){
  var obj = JSON.parse(resp);
  if('state' in obj){
    console.log(obj);
  } else {
    devices = obj;
    console.log(obj);

    var fillup_device = document.getElementById("fillup_device");
    var supply_device = document.getElementById("supply_device");
    fillup_device.innerHTML = '';
    supply_device.innerHTML = '';
    for(var i = 0; i < obj.length; i++) {
        var el = document.createElement("option");
        el.textContent = obj[i].device;
        el.value = i;
        fillup_device.appendChild(el);
        var el = document.createElement("option");
        el.textContent = obj[i].device;
        el.value = i;
        supply_device.appendChild(el);
    }
    get_device_config();
  }
}

function get_products(){
  url = `${api}/get_products`;
  httpGetAsync(url,handle_get_products);
}

function handle_get_products(resp){
  var obj = JSON.parse(resp);
  if('state' in obj){
    console.log(obj);
  } else {
    //console.log(obj);
    products = obj;  
  }
}

function get_device_config(){
  var sel = document.getElementById('fillup_device');
  var dev = sel.options[sel.selectedIndex].text;
  if(dev != ""){
    url = `${api}/get_device_config`;
    httpGetAsync(url,handle_get_device_config, `device=${dev}`);
  }
}

function handle_get_device_config(resp){
  var obj = JSON.parse(resp);
  if('state' in obj){
    console.log(obj);
  } else {
    //console.log(obj);
    CreateFillTable('fill_table',parseInt(devices[document.getElementById('fillup_device').value].slots), obj, 'fillup');
  }
}

function reset_password(mail){
  var url = `${api}/reset_passwd_mail`;
  httpGetAsync(url,handle_reset_password, `mail=${mail}`);
}

function handle_reset_password(resp){
  var obj = JSON.parse(resp);
  if(obj.state == 'success'){
    alert("Bitte den Link in der Email verwenden");
    reload_home();
  } else {
    console.log(obj);
    alert(`Fehler: ${obj.state}`);
  }
}

function set_password(t, pw, pw_old){
  var url = `${api}/set_password`;
  if(pw_old){
      httpGetAsync(url,handle_set_password, `token=${t}&pw=${pw}&pw_old=${pw_old}`);
  } else {
      httpGetAsync(url,handle_set_password, `token=${t}&pw=${pw}`);
  }
}

function handle_set_password(resp){
  var obj = JSON.parse(resp);
  if(obj.state == 'success'){
    hide_div('change_passwd');
    alert("Passwort erfolgreich gesetzt");
    reload_home();
  } else {
    console.log(obj);
    alert(`Fehler: ${obj.state}`);
  }
}

function reload_home(){
  window.location.replace('https://spezispezl.de'); 
}



function httpGetAsync(theUrl, callback, data)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == XMLHttpRequest.DONE && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
    }
    if(data){
      xmlHttp.open("POST", theUrl, true); // true for asynchronous 
      xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xmlHttp.send(data);
    } else {
      xmlHttp.open("GET", theUrl, true); // true for asynchronous 
      xmlHttp.send(null);
    }
}


function CreateTableFromJSON(div, json, limit) {
    var col = [];
    for (var i = 0; i < limit; i++) {
        for (var key in json[i]) {
            if (col.indexOf(key) === -1) {
                col.push(key);
            }
        }
    }


    var table = document.createElement("table");
    table.setAttribute('class', 'table table-dark');
    var tr = table.insertRow(-1);                   // TABLE ROW.
    for (var i = 0; i < col.length; i++) {
        var th = document.createElement("th");      // TABLE HEADER.
        th.innerHTML = col[i];
        tr.appendChild(th);
    }
    for (var i = 0; i < limit; i++) {
        tr = table.insertRow(-1);
        for (var j = 0; j < col.length; j++) {
            var tabCell = tr.insertCell(-1);
            tabCell.innerHTML = json[i][col[j]];
        }
    }
    var divContainer = document.getElementById(div);
    divContainer.innerHTML = "";
    divContainer.appendChild(table);
}

function get_opt_prod(selected){
  var opt ="";
  for (var i=0; i< products.length; i++){
    var sel = "";
    if (products[i].name == selected){sel = 'selected'}
    opt = opt+ `<option value="${products[i].name}" ${sel}>${products[i].name}</option>\n`
    if(i == products.length -1){  return opt;}
  } 
}

function get_opt_items(selected, max_items ){
  var opt ="";
  for (var i=0; i< max_items+1; i++){
    var sel = "";
    if (i == selected){sel = 'selected'}
    opt = opt+ `<option value="${i}" ${sel}>${i}</option>\n`
    if(i == max_items){  return opt;}
  } 
}


function CreateFillTable(div, slots, data, formname) {


    var col = ['Slot','Produkt', 'Füllstand'];
   // for (var i = 0; i < slots; i++) {
   //     for (var key in data[i]) {
   //         if (col.indexOf(key) === -1) {
   //             col.push(key);
   //         }
   //     }
   // }
    var table = document.createElement("table");
    table.setAttribute('class', 'table table-dark');
    var tr = table.insertRow(-1);                   // TABLE ROW.
    for (var i = 0; i < 3; i++) {
        var th = document.createElement("th");      // TABLE HEADER.
        th.innerHTML = `<p class="fill_text">${col[i]}</p>`;
        tr.appendChild(th);
    }
    for (var i = 0; i < slots; i++) {
        tr = table.insertRow(-1);
        for (var j = 0; j < 3; j++) {
            var tabCell = tr.insertCell(-1);


            if(j == 0){ tabCell.innerHTML = `<p class="fill_text">${i+1}</p>`;}// slot number
            if(j == 1){ tabCell.innerHTML = `<select id="product_${i}" form="${formname}" name="data"> ${get_opt_prod(data[i].product)} </select>`; }// product
            if(j == 2){ tabCell.innerHTML = `<select id="items_${i}" form="${formname}" name="data"> ${get_opt_items(data[i].items, data[i].max_items)} </select>`; }// items
              
        }
    }
    var divContainer = document.getElementById(div);
    divContainer.innerHTML = "";
    divContainer.appendChild(table);
    divContainer.style.display = 'block';
}


  function check_mobile(){
    a = navigator.userAgent||navigator.vendor||window.opera;
    if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))){
      return true;
    } return false;
  }

init();

    </script>
  </body>
</html>